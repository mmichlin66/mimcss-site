!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.mimurl=t():e.mimurl=t()}(this,(function(){return(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function r(e){return/^[a-z0-9_\-]+$/i.test(e)}function n(e){return/^[a-z0-9_\-\.%]+$/i.test(e)}function s(e){return/^[a-z0-9_\-]+$/i.test(e)}let a,i,o,l;function h(){return o>=i}function u(e){if(o===i){let t="Unexpected end of URL pattern";throw e&&(t+=": "+e),new O(t)}}function c(e=1){return o<=i-e?(o+=e,l=a[o],!0):(o=i,!1)}e.r(t),e.d(t,{EUrlPart:()=>q,FieldFormat:()=>k,match:()=>M,parseURL:()=>H,parseUrlPattern:()=>B});class f{constructor(){this.patternString=a,this.parts=[]}get protocol(){return this.parts[q.Protocol]}get hostname(){return this.parts[q.Hostname]}get port(){return this.parts[q.Port]}get path(){return this.parts[q.Path]}get query(){return this.parts[q.Query]}get hash(){return this.parts[q.Hash]}parse(){for(let e=this.findFirstUrlPart();null!==e&&(e.parse(),this.parts[e.urlPart]=e,!h());e=e.getNextUrlPart());}findFirstUrlPart(){if("/"===l)return i>1&&"/"===a[1]?(c(2),new y):(c(),new x);{let e=a.indexOf("://");if(e>0)return new w;if(e<0)return new y;throw new O("URL pattern cannot start from '://'")}}}class p{constructor(){this.location={start:o,length:0}}finalize(){this.location.length=o-this.location.start,this.tokenSting=a.substr(this.location.start,this.location.length)}}class d extends p{constructor(e,t){super(),this.urlPart=e,this.caseSensitive=t}}class m extends d{constructor(e,t){super(e,t)}parse(){let e=new E;e.parse(this.getSegmentEndCharacters(),!1,this.caseSensitive),this.segment=e,this.finalize()}getSegments(){return[this.segment]}}class g extends d{constructor(e,t){super(e,t),this.segments=[]}parse(){let e=this.getPartEndCharacters();for(;!h();){let t=new E;if(t.parse(this.getSegmentEndCharacters(),!0,this.caseSensitive),this.segments.push(t),e.indexOf(l)>=0)break;c()}this.finalize()}getSegments(){return this.segments}}class w extends m{constructor(){super(q.Protocol,!1)}getSegmentEndCharacters(){return":"}getNextUrlPart(){if(":"===l&&o+2<i&&"/"===a[o+1]&&"/"===a[o+2])return c(3),u(),new y;throw new O("Invalid characters after protocol part")}}class y extends g{constructor(){super(q.Hostname,!1)}getSegmentEndCharacters(){return".:/?#"}getPartEndCharacters(){return":/?#"}getNextUrlPart(){if(":"===l)return c(),u("Port cannot be empty"),new $;if("/"===l)return c(),h()?null:new x;if("?"===l)return c(),h()?null:new b;if("#"===l)return c(),h()?null:new P;throw new O(`Invalid character '${l}' after hostname segment`)}}class $ extends m{constructor(){super(q.Port,!1)}getSegmentEndCharacters(){return"/?#"}getNextUrlPart(){if("/"===l)return c(),h()?null:new x;if("?"===l)return c(),h()?null:new b;if("#"===l)return c(),h()?null:new P;throw new O(`Invalid character '${l}' after port part`)}}class x extends g{constructor(){super(q.Path,!0)}getSegmentEndCharacters(){return"/?#"}getPartEndCharacters(){return"?#"}getNextUrlPart(){if("?"===l)return c(),h()?null:new b;if("#"===l)return c(),h()?null:new P;throw new O(`Invalid character '${l}' after path segment`)}}class b extends d{constructor(){super(q.Query,!0),this.parsedQSPs={},this.allowExtraQueryParams=!0}parse(){for(;!h()&&"#"!==l;)if("!"===l)this.allowExtraQueryParams=!1,c();else{let e=new v;if(e.parse(),e.name in this.parsedQSPs)throw new O(`Query string parameter '${e.name}' appears more than once`);this.parsedQSPs[e.name]=e,"&"===l&&c()}this.finalize()}getNextUrlPart(){if("#"===l)return c(),h()?null:new P;throw new O(`Invalid character '${l}' after query string segment`)}getSegments(){let e=[];for(let t in this.parsedQSPs)e.push(this.parsedQSPs[t].segment);return e}}class P extends m{constructor(){super(q.Hash,!0)}getSegmentEndCharacters(){return""}getNextUrlPart(){return null}}class v extends p{constructor(){super(),this.name=""}parse(){for(;!h()&&"=&#".indexOf(l)<0;)this.name+=l,c();if(!this.name)throw new O("Query string parameter doesn't have name");if(e=this.name,!/^[a-z0-9_\-]+$/i.test(e))throw new O(`Query string parameter name '${this.name}' contains invalid character`);var e;if(h()||"="!==l)throw new O(`Query string parameter '${this.name}' must be followed by '='`);c(),u(`Query string parameter '${this.name}' doesn't have value`);let t=new E;t.parse("&#",!0,!0),this.segment=t,this.finalize()}isNameEndCharacter(e){return"=&#".indexOf(e)>=0}}class E extends p{constructor(){super(),this.isOptional=!1,this.isMulti=!1,this.fields=[]}parse(e,t,r){this.analizeFirstChar(e,t)&&c();let n=[];for(;!h()&&e.indexOf(l)<0;){let t;if("{"===l){let r=new R;r.parse(e),t=r}else if("("===l){let e=new S;e.parse(),t=e}else{let r=new U;r.parse(e+"{("),t=r}n.push(t)}this.generateRegExp(n,r),this.finalize()}analizeFirstChar(e,t){switch(l){case"?":return this.isOptional=!0,!0;case"!":return!0;case"*":if(!t)throw new O("Single-value segment URL part cannot start from '*'");return this.isOptional=this.isMulti=!0,!0;case"+":if(!t)throw new O("Single-segment URL part cannot start from '+'");return this.isMulti=!0,!0;default:if(e.indexOf(l)>=0)throw new O("Empty segment encountered");return!1}}generateRegExp(e,t){let r=1,n="";if(0===e.length)n+=".+";else for(let t of e)t instanceof U?n+=t.content:t instanceof S?(n+="("+t.content+")",r+=1+t.capturingGroupQty):(t.isArray=this.isMulti,t.index=r,this.fields.push(t),n+=this.generateRegExpSectionForField(t),r++,t.matchPattern&&(r+=1+t.matchPattern.capturingGroupQty));this.regExp=new RegExp(n,t?"":"i")}generateRegExpSectionForField(e){let t="";return e.matchPattern&&e.matchPattern.content?(t+=e.matchPattern.content,e.isOptional&&(t+="?")):e.isOptional?t+="(.*)":t+="(.+)",t}}class U extends p{constructor(){super(),this.content=""}parse(e){let t="";for(;!h()&&e.indexOf(l)<0;)t+=l,c();if(!function(e){return/^[a-z0-9_\-\.%]+$/i.test(e)}(t))throw new O(`Text token '${t}' contains invalid characters`);try{this.content=decodeURIComponent(t)}catch(e){throw new O(`Text token '${t}' cannot be URL-decoded. Error: ${e.message}`)}this.finalize()}}class S extends p{constructor(){super(),this.content="",this.capturingGroupQty=0}parse(){let e=[];for(;!h();){let t=l;if(")"===t){if("("!==e.pop())throw new O(`Non-matching character '${t}' in regular expression`);if(c(),0===e.length)return this.content+=t,void this.finalize()}else if("}"===t){if("{"!==e.pop())throw new O(`Non-matching character '${t}' in regular expression`);c()}else if("]"===t){if("["!==e.pop())throw new O(`Non-matching character '${t}' in regular expression`);c()}else"({[".indexOf(t)>=0?("("===t&&this.capturingGroupQty++,e.push(t),c()):"\\"===t?(this.content+=t,c(),u(`In the Regexp '${this.content}', the escape character '\\' must be followed by another character`),t=l,c()):c();this.content+=t}throw new O("Invalid URL pattern end within regular expression")}finalize(){if(!this.content)throw new O("Empty regular expression");super.finalize()}}class R extends p{constructor(){super(),this.isOptional=!1,this.name="",this.format=k.String,this.matchPattern=null}parse(e){for(c(),u("A field must define a name"),"?"===l&&(this.isOptional=!0,c());!h();){if(e.indexOf(l)>=0)throw new O("Field doesn't have closing '}'");if("}(%=".indexOf(l)>=0)break;this.name+=l,c()}if(0===this.name.length)throw new O("Field must have name");if(t=this.name,!/^[a-z_][a-z0-9_]*$/i.test(t))throw new O(`Field name '${this.name}' contains invalid characters`);var t;if(u(`Field '${this.name}' doesn't have closing '}'`),"%"===l){c(),u(`Field '${this.name}' doesn't specify format after '%'`);let e=l;if("i"===e)this.format=k.Integer,c();else if("f"===e)this.format=k.Float,c();else{if("b"!==e)throw new O(`Field '${this.name}' has invalid format character '${l}'`);this.format=k.Boolean,c()}u(`Field '${this.name}' doesn't have closing '}'`)}if("("===l){let e=new S;e.parse(),this.matchPattern=e,u(`Field '${this.name}' doesn't have closing '}'`)}if("="===l)this.isOptional=!0,c(),this.parseDefaultValue(e);else switch(this.format){case k.Integer:case k.Float:this.defaultValue=NaN;break;case k.Boolean:this.defaultValue=void 0;break;default:this.defaultValue=""}if("}"!==l)throw new O(`Field '${this.name}' has invalid character '${l}'`);this.finalize(),c()}parseDefaultValue(e){let t="";for(;!h();){if(e.indexOf(l)>=0)throw new O(`Field '${this.name}' doesn't have closing '}'`);if("}"===l)break;t+=l,c()}if(!t)throw new O(`Field '${this.name}' default value cannot be empty`);if(t=decodeURIComponent(t),this.format===k.Integer){if(this.defaultValue=Number(t),isNaN(this.defaultValue)||!Number.isInteger(this.defaultValue))throw new O(`Default value '${t}' of Integer field '${this.name}' cannot be converted to Integer`)}else if(this.format===k.Float){if(this.defaultValue=Number(t),isNaN(this.defaultValue))throw new O(`Default value of '${t}' Float field '${this.name}' cannot be converted to Float`)}else if(this.format===k.Boolean){let e=t.toLowerCase();if("true"===e||"t"===e||"yes"===e||"y"===e||"1"===e)this.defaultValue=!0;else{if("false"!==e&&"f"!==e&&"no"!==e&&"n"!==e&&"0"!==e)throw new O(`Default value of '${t}' Boolean field '${this.name}' cannot be converted to Boolean`);this.defaultValue=!1}}else this.defaultValue=t}}class O extends Error{constructor(e){super(),this.pos=o,this.message=`Error at position ${this.pos}: ${e}`}}function L(e,t,r,n){return"number"==typeof t&&(t=t.toString()),r?t?F(t,r,n)?null:`URL segment '${t}' in part '${q[e]}' doesn't match pattern segment '${r.tokenSting}'`:r.isOptional?null:`URL part '${q[e]}' doesn't have a segment corresponding to a mandatory pattern segment '${r.tokenSting}'`:t?`URL part '${q[e]}' contains segment '${t}' that doesn't exist in the pattern`:null}function F(e,t,r){let n=t.regExp.exec(e);if(!n||n[0]!==e)return!1;for(let e of t.fields){if(e.index>=n.length)return console.error("BUG: Field index not found in patter's regular expression execution result"),!1;let t=z(e,n[e.index]);if(e.isArray){let n=r[e.name];void 0===n&&(n=[],r[e.name]=n),n.push(t)}else r[e.name]=t}return!0}function N(e,t,r,n){if(!t&&!r)return null;if(!t)return`URL doesn't have part '${q[e]}' that exists in the pattern`;if(!r)return`URL has part '${q[e]}' that doesn't exist in the pattern`;let s=[];for(let e of r)e.isMulti&&!e.isOptional?(s.push(new V(e,!1)),s.push(new V(e,!0))):s.push(new V(e,e.isOptional));return Q(t,0,s,0,n)?null:`URL part '${q[e]}' doesn't match the pattern`}function Q(e,t,r,n,s){let a=t,i=n;for(;i<r.length&&a<e.length;){let t=r[i],n=e[a];if(t.isOptional){let o={};if(Q(e,a,r,i+1,o))return I(s,o),!0;if(o={},!F(n,t.parsedSegment,o))return!1;I(s,o),a++,t.parsedSegment.isMulti||i++}else{if(!F(n,t.parsedSegment,s))return!1;i++,a++}}if(i===r.length&&a===e.length)return!0;if(i===r.length)return!1;for(let e=i;e<r.length;e++)if(!r[e].isOptional)return!1;return!0}function I(e,t){for(let r in t){let n=t[r],s=e[r];if(void 0===s)e[r]=n;else{let e=n,t=s;for(let r of e)t.push(r)}}}function z(e,t){if(!t)return e.defaultValue;switch(e.format){case k.Integer:{let r=Number(t);return isNaN(r)||!Number.isInteger(r)?e.defaultValue:r}case k.Float:{let r=Number(t);return isNaN(r)?e.defaultValue:r}case k.Boolean:{let r=t.toLowerCase();return"true"===r||"t"===r||"yes"===r||"y"===r||"1"===r||"false"!==r&&"f"!==r&&"no"!==r&&"n"!==r&&"0"!==r&&e.defaultValue}default:return t}}class V{constructor(e,t){this.parsedSegment=e,this.isOptional=t}}class C{get success(){return!this.errors||0===this.errors.length}}var q,k;function H(e){return function(e){let t,a={},i=e.indexOf("://");if(0===i)throw new Error("URL cannot start from '://'");if(i>0){if(a.protocol=e.substr(0,i),o=a.protocol,!/^[a-z0-9]+$/i.test(o))throw new Error(`Protocol '${a.protocol}' contains invalid characters`);t=i+3}else t="/"===e[0]?-1:0;var o;let l=t<0?0:t,h=e.indexOf(":",l),u=e.indexOf("/",l),c=e.indexOf("?",l),f=e.indexOf("#",l);if(t>=0){a.hostname=h>0?e.substr(t,h-t).split("."):u>0?e.substr(t,u-t).split("."):c>0?e.substr(t,c-t).split("."):f>0?e.substr(t,f-t).split("."):e.substr(t).split(".");for(let e=0;e<a.hostname.length;e++){let t=a.hostname[e];if(!r(t))throw new Error(`Hostname segment '${t}' contains invalid characters`)}}if(h>0){let t;if(t=u>0?e.substr(h+1,u-h-1):c>0?e.substr(h+1,c-h-1):f>0?e.substr(h+1,f-h-1):e.substr(h+1),!function(e){return/^\d+$/i.test(e)}(t))throw new Error(`Port '${t}' contains non-numerical characters`);a.port=Number(t)}if(u>=0){a.path=c>0?e.substr(u+1,c-u-1).split("/"):f>0?e.substr(u+1,f-u-1).split("/"):e.substr(u+1).split("/");for(let e=0;e<a.path.length;e++){let t=a.path[e];if(!n(t))throw new Error(`Path segment '${t}' contains invalid characters`);try{t=decodeURIComponent(t)}catch(e){throw new Error(`Path segment '${t}' cannot be URL-decoded. Error: ${e.message}`)}a.path[e]=t}}if(c>0){let t;a.query={},t=f>0?e.substr(c+1,f-c-1):e.substr(c+1);let r=t.split("&");for(let e of r){if(!e)throw new Error("Invalid stucture of query string URL part");let t,r,i=e.split("=");if(i.length>2)throw new Error(`Query string parameter '${e}' has more than one '=' symbol`);if(i.length<2?(t=e,r=void 0):(t=i[0],r=i[1]),!s(this.name))throw new Error(`Query string parameter name '${t}' contains invalid character`);if(r){if(!n(r))throw new Error(`Value '${r}' of query string parameter '${t}' contains invalid characters`);try{r=decodeURIComponent(r)}catch(e){throw new Error(`Value '${r}' of query string parameter '${t}' cannot be URL-decoded. Error: ${e.message}`)}}t in a.query?a.query[t].push(r):a.query[t]=[r]}}if(f>0){let t=e.substr(f+1);if(!n(t))throw new Error(`Value '${t}' of hash URL part contains invalid characters`);try{a.hash=decodeURIComponent(t)}catch(e){throw new Error(`Value '${t}' of hash URL part cannot be URL-decoded. Error: ${e.message}`)}}return a}(e)}function B(e){return function(e){if(a=e,i=0,o=0,l="",!e)throw new O("URL pattern cannot be empty");i=e.length,l=e[0];let t=new f;return t.parse(),t}(e)}function M(e,t){return function(e,t){if(!e)throw new Error("URL cannot be null or empty string");if(!t)throw new Error("Pattern cannot be null or empty string");return function(e,t){if(!e)throw new Error("URL cannot be null");if(!t)throw new Error("parsedPattern cannot be null");let r=new C;r.parsedURL=e,r.fields={};let n=[];try{let s=L(q.Protocol,e.protocol,t.protocol?t.protocol.segment:null,r.fields);s&&n.push(s),s=N(q.Hostname,e.hostname,t.hostname?t.hostname.segments:null,r.fields),s&&n.push(s),s=L(q.Port,e.port,t.port?t.port.segment:null,r.fields),s&&n.push(s),s=N(q.Path,e.path,t.path?t.path.segments:null,r.fields),s&&n.push(s),s=function(e,t,r){if(!t)return null;if(!e)return 0===Object.keys(t.parsedQSPs).length?null:"URL doesn't have query string parameters specified in the pattern";for(let r in t.parsedQSPs)if(void 0===e[r])return`URL doesn't have query string parameter '${r}'`;for(let n in e){let s=t.parsedQSPs[n].segment;if(s){let t=e[n];if(!s.isMulti&&t.length>1)return`URL has multiple values for query string parameter '${n}' while pattern doesn't specify it as multi`;for(let e of t)if(!F(e,s,r))return`URL's query string parameter '${n}' doesn't match that specified in the pattern`}else if(!t.allowExtraQueryParams)return`URL has query string parameter '${n}' that is not specified in the pattern`}return null}(e.query,t.query,r.fields),s&&n.push(s),s=L(q.Hash,e.hash,t.hash?t.hash.segment:null,r.fields),s&&n.push(s)}catch(e){n.push(e.message)}return n.length>0&&(r.errors=n),r}("string"==typeof e?H(e):e,"string"==typeof t?B(t):t)}(e,t)}return function(e){e[e.Protocol=0]="Protocol",e[e.Hostname=1]="Hostname",e[e.Port=2]="Port",e[e.Path=3]="Path",e[e.Query=4]="Query",e[e.Hash=5]="Hash"}(q||(q={})),function(e){e[e.String=0]="String",e[e.Integer=1]="Integer",e[e.Float=2]="Float",e[e.Boolean=3]="Boolean"}(k||(k={})),t})()}));